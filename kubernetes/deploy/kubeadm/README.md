# Kubeadm 部署 Kubernetes 集群

使用 kubeadm 默认会启动一个安全的 kubernetes 集群，但依然不建议在生产环境使用，原因有许多，比如：etcd 存在单点故障问题。

## 组件

| 组件名            | 含义   |
| -------------- | ---- |
| kubeadm        |      |
| kubelet        |      |
| kubectl        |      |
| kubernetes-cni |      |

## 安装 Docker

Kubeadm 目前已验证的最大 Docker 版本是 `1.12.6`，安装 Dcoker 的详细步骤：[安装攻略](../../docker/docker-install.md)。

```bash
$ # 确保 docker 已在运行
$ docker info

$ # 验证 cgroup driver
$ docker info | grep Cgroup
Cgroup Driver: cgroupfs
```

## 安装 Kubeadm

`kubeadm` 软件包包含 `kubectl`、`kubelet`、`kubernetes-cni`、`socat` 依赖包；`kubelet` 软件包包含 `kubernetes-cnt`、`socat` 依赖包。

```bash
$ # 添加源
$ cat >> /etc/yum.repos.d/kubernetes.repo <<EOF
[kubernetes]
name=Kubernetes
baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/
enabled=1
gpgcheck=0
repo_gpgcheck=0
gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg
        https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg
EOF

$ # 关闭防火墙
$ systemctl stop firewalld && systemctl disable firewalld

$ # 临时禁用 SELinux
$ setenforce 0

$ # 安装最新版本（推荐）
$ yum install -y kubelet kubeadm

$ # 安装指定版本（依赖包实际上还是最新版本，比如 kubectl）
$ yum install -y kubelet-1.6.2 kubeadm-1.6.2

$ # 设置 kuberlet 开机自启动
$ systemctl enable kubelet.service
```

修改内核参数：

```bash
$ cat > /etc/sysctl.d/k8s.conf <<EOF
net.bridge.bridge-nf-call-iptables = 1
net.bridge.bridge-nf-call-ip6tables = 1
EOF
$
$ # 立即生效
$ sysctl -p /etc/sysctl.d/k8s.conf
$
$ # 检验
$ sysctl net.bridge.bridge-nf-call-iptables
$ sysctl net.bridge.bridge-nf-call-ip6tables
```

## 部署

* **master**

如果缺少相应的 `gcr.io/google_containers/*` 镜像，执行 `kubeadm init` 等操作会被卡住，具体需要哪些版本的镜像可以在 `/etc/kubernetes/` 目录下查看具体的 manifest。

```bash
$ # 获取相关版本的镜像
$ ./k8s-master-image.sh v1.6.2
```

在 CentOS 上初始化 v1.6 版本的 Kubernetes 集群时，还可能出现如下错误：

```bash
$ # error: failed to run Kubelet: failed to create kubelet: misconfiguration: kubelet cgroup driver: "systemd" is different from docker cgroup driver: "cgroupfs"

$ # 原因： docker 的 cgroup driver 和 kubelet 的 cgroup driver 不一致，我们统一使用 cgroupfs

$ # 修改
$ sed -i "s|--cgroup-driver=systemd|--cgroup-driver=cgroupfs|g" /etc/systemd/system/kubelet.service.d/10-kubeadm.conf
$ system daemon-reload

$ # 检查
$ cat /etc/systemd/system/kubelet.service.d/10-kubeadm.conf | grep "cgroup-driver"
```

```bash
$ # 检查本机私有 IP 是否正确且唯一，如果有误请修改 /etc/hosts 文件
$ hostname -i

$ # kubernete 使用和 kubeadm 相同的版本（kubeadm version）
$ kubeadm init --apiserver-advertise-address=$(hostname -i)

$ # 部署指定版本（推荐）
$ kubeadm init --kubernetes-version=v1.6.2 --apiserver-advertise-address=$(hostname -i) --pod-network-cidr=10.17.0.0/16 --service-cidr=10.96.0.0/16

$ # 客户端（kubectl）需要有配置和证书，才能使用操作、管理 Kubernetes 集群

$ # 配置 kubectl（方法一）
$ mkdir -p $HOME/.kube
$ cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
$ chown $(id -u):$(id -g) $HOME/.kube/config

$ # 配置 kubectl（方法二）
$ sudo cp /etc/kubernetes/admin.conf $HOME/
$ sudo chown $(id -u):$(id -g) $HOME/admin.conf
$ export KUBECONFIG=$HOME/admin.conf

$ # 初始化 master 后如果忘了 token，可以通过下面的命令查看
$ kubeadm token list
TOKEN                     TTL         EXPIRES   USAGES                   DESCRIPTION
a1ed36.7bba409461c70635   <forever>   <never>   authentication,signing   The default bootstrap token generated by 'kubeadm init'.
```

如果 `kubeadm init` 失败或者 `kubeadm join` 失败可以通过 `kubeadm reset` 来清除所有的修改，包括运行的容器以及 `/etc/kubernetes` 下的相关文件。

* **node**

```bash
$ # kubeadm join --token=<token> <ip-of-master>:<port>
$ kubeadm join --token=a1ed36.7bba409461c70635 10.0.13.3:6443

$ # 配置 kubectl
$ 

$ # 检验节点是否加入了集群。由于没有部署容器网络，node 处于 NotReady 状态
$ kubectl get nodes

$ #
$ netstat -tpln | grep -Eo ".*(etcd|kube-scheduler|kube-controlle|kube-apiserver|kubelet|kube-proxy).*"
```

* **网络**

部署完集群后并还需要手动初始化集群网络，否则应用容器和 `kube-dns` 等插件都将无法启动。

```bash
$ # 部署前先看看哪些容器没有成功启动
$ kubectl get pods --all-namespaces

$ # weave
$ kubectl apply -n kube-system -f "https://cloud.weave.works/k8s/net?k8s-version=$(kubectl version | base64 | tr -d '\n')"

$ # calico
$ 

$ # 检查容器是否都已经处于 Running 状态
$ kubectl get pods --all-namespaces

$ # 检查 node 是否都已经处于 Ready 状态
$ kubectl get nodes
```

* **Dashboard**

```bash
$ curl -L -s https://git.io/kube-dashboard  | sed 's/targetPort: 9090/targetPort: 9090\n  type: LoadBalancer/' | kubectl apply -f -
```



## 参考

* [kubeadm 安装 Kubernetes-1.6.1 集群](http://www.iyunv.com/thread-383771-1-1.html)
* [Installing kubeadm](https://kubernetes.io/docs/setup/independent/install-kubeadm/)
* [Using kubeadm to Create a Cluster](https://kubernetes.io/docs/setup/independent/create-cluster-kubeadm/)