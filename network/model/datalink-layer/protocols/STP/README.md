# STP 协议

生成树协议（Spanning Tree Protocol，缩写：**STP**）是一种工作在 OSI 网络模型中的第二层通信协议，主要用于防止交换机冗余链路产生的环路，确保以太网形成无环路的逻辑拓扑结构，从而避免广播风暴大量占用交换机的资源。

## 交换机环路问题

当两个交换机将两个局域网同时连接起来时，会出现常见的 **环路问题**。

![交换机环路](../.images/bridge-loop.png)

问题描述：

1. 假设 PC1 需要访问 PC2，PC1 发起一个 ARP 广播，PC2 收到请求后回应自己的 MAC 地址
2. Switch-A 左网口收到广播包时
   2.1. Switch-A 一开始并不知道 PC2 位于哪个局域网，所以将消息从右网口广播到 LAN2
   2.2. Switch-B 右网口收到广播消息，并将广播消息从左网口广播到 LAN1
   2.3. 广播包又到达 Switch-A 左网口，Switch-A 再次将包广播到 LAN1
   2.4. 最终，该广播包在 Switch-A 上形成一个顺时针环路
3. Switch-B 左网口收到广播包后，形成一个逆时针环路
4. 对 Switch-A 而言，PC1 的广播包一会儿出现在左网口，一会儿出现在右网口。根据学习机制，Switch-A 会认为 PC1 换了位置，反复将上一次学到的记录清理掉。同理，Switch-B 同样会反处于混乱之中。

## 基本概念

* **ROOT Bridge**：根交换机，相当于树的 “根”
* **Designated Bridges**： 指定交换机，相当于树的 “树枝”，而不是 “叶子”
* **Bridge Protocol Data Units**（**BPDU**）： 网桥协议数据单元；BPDU 只有 “根” 可以发，已经隶属于某个 “根” 的交换机只能传达 “根” 的指示
* **Priority Vector**：优先级向量，相当于 “树干” 的粗细，值越小优先级越高；由一组 `[Root Bridge ID,Root Path Cost, Bridge ID,Port ID]` 组成。如何比较优先级：
  1. 先看 Root Bridge ID，即看 “根” 的优先级
  2. 再比 Root Path Cose，即比较到达 “根” 的距离
  3. 最后比 Bridge ID，即比较自己的 ID

## 工作原理

任意一台交换机如果到达根交换机有两条或者两条以上的链路，生成树协议都根据算法把其他链路切断，仅保留优先级最高的一条，从而确保两个交换机之间只有一条单一的活动链路，避免了环路的出现。

## 工作过程

## STP 端口状态

| 端口状态   | 端口能力                                              |
| ---------- | ----------------------------------------------------- |
| Disabled   | 不发送任何报文                                        |
| Blocking   | 不接收或不转发数据，接收但不发送 BPDU，不进行地址学习 |
| Listening  | 不接收或不转发数据，接收并发送 BPDU，不进行地址学习   |
| Learning   | 不接收或者不转发数据，接受并发送 BPDU，进行地址学习   |
| Forwarding | 接收或转发数据，接收并发送 BPDU，进行地址学习         |

## 快速生成树协议（RSTP）