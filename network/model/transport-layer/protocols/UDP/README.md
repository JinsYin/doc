# UDP 协议

**UDP**（User Datagram Protocol，用户数据报协议）

## 工作过程

![UDP 包头](../.images/udp-header.png)

1. 当发送的 UDP 包到达目标机器后，发现 MAC 地址匹配，就摘下 MAC 头，将剩下的包交由内核 IP 层代码处理
2. 内核 IP 层代码摘下 IP 头，发现目标 IP 匹配；由于 IP 头中有一个 8 位协议，记录着传输协议是 UDP 还是 TCP，因而内核可以根据 UDP 头或 TCP 头的格式将数据解析出来。
3. 内核处理完传输层的事情，将剩下的数据包交由应用程序自己处理
4. 无论应用程序使用 TCP 还是 UDP 传输数据，都需要监听一个端口，即 TCP 头和 UDP 头都包含有端口号（`源端口号` 和 `目标端口号`）。根据目标端口号，可以确定将数据交给哪个应用程序，由此可见 **端口不能冲突**。

> **端口不能冲突** 是针对同一传输协议而言的，UDP 应用程序和 TCP 应用程序可以同时监听同一个端口号

## 三大特点

| 特点         | 描述                                                                                                                   |
| ------------ | ---------------------------------------------------------------------------------------------------------------------- |
| **沟通简单** | 不需要大量的数据结构、处理逻辑、包头字段                                                                               |
| **轻信他人** | 不会建立连接；端口就监听在这个地方，谁都可以传输数据给它，它也可以传输数据给任何人，甚至同时传输给多人                 |
| **不懂权变** | 不知道什么时候该坚持，什么时候该退让；不会根据网络的情况进行发包的拥堵控制，不论网络包是否丢弃，依然是该怎么发还怎么发 |

## 应用场景

* 需要资源少，在网络情况比较好的内网，或者对于丢包不敏感的应用
  * 基于 UDP 的协议：自动获取 IP 地址的 DHCP、PXE 自动下载操作系统的 TFTP
* 不需要一对一沟通，建立连接，而是可以广播的应用。UDP 的无连接功能，使得其可以承载广播或多播（组播）的协议
  * 广播形式的 DHCP
  * 组播形式的 VXLAN
* 需要处理速度快，时延低，可以容忍少数丢包，但要求即便网络拥堵也要一如既往

## 基于 UDP 的实例

* 网页或 APP 的访问

**QUIC**（全称：Quick UDP Internet Connections，快速 UDP 互联网连接）是谷歌提出的一种基于 UDP 改进的互联网传输层协议，旨在降低网络通信的延迟，改善用户体验。QUIC 具有 `快速建立连接`、`减少重传时延` 和 `自适应拥塞控制` 的特点。

* 流媒体的协议

因而，很多直播应用都基于 UDP 实现了自己的视频传输协议。

* 实时游戏

游戏对实时性要求较为严格，采用自定义的可靠 UDP 协议，自定义重传策略，能够把丢包产生的延迟降低到最低，尽量减少网络问题对游戏实时性造成的影响。

* IoT 物联网

一方面，物联网领域终端物理资源少，对于内存较小的嵌入式系统，维护 TCP 协议代价太大；另一方面，物联网对实时性要求较高，而 TCP 协议同样因为上面的原因导致时延大。

谷歌其下的 Nest 建立 Thread Group，推出了基于 UDP 的物联网通信协议 Thread 。

* 移动通信领域

4G 网络中，移动流量上网的数据使用的是基于 UDP 的 GTP-U 协议。因为移动网络协议比较复杂，而 GTP 协议本身就是包含复杂的手机上限下线的通信协议，如果基于 TCP，TCP 的机制显得非常多余。
