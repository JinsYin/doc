# Ceph 协议

```c
+--------------------------------------------+
|  Ceph Storage Cluster Protocol (librados)  |
+--------------------------------------------+

+-------------------+    +-------------------+
|        OSDs       |    |     Monitors      |
+-------------------+    +-------------------+
```

## 原生协议和 librados

## 对象监听和通知

```c
+----------+       +----------+         +-----------+         +---------------+
| Client 1 |       | Client 2 |         |  Client 3 |         | OSD Object ID |
+----------+       +----------+         +-----------+         +---------------+
     |                  |     Watch Object    |                       |
     |--------------------------------------------------------------->|
     |<---------------------------------------------------------------|
     |                  |      Ack/Commit     |                       |
     |                  |                     |                       |
     |                  |     Watch Object    |                       |
     |                  |-------------------------------------------->|
     |                  |<--------------------------------------------|
     |                  |      Ack/Commit     |                       |
     |                  |                     |      Watch Object     |
     |                  |                     |---------------------->|
     |                  |                     |<----------------------|
     |                  |                     |       Ack/Commit      |
     |                  |        Notify       |                       |
     |--------------------------------------------------------------->|
     |<---------------------------------------------------------------|
     |                  |        Notify       |                       |
     |                  |                     |                       |
     |                  |                  Notify                     |
     |                  |<--------------------------------------------|
     |                  |                     |         Notify        |
     |                  |                     |<----------------------|
     |                  |         Ack         |                       |
     |--------------------------------------------------------------->|
     |                  |                    Ack                      |
     |                  |-------------------------------------------->|
     |                  |                     |           Ack         |
     |                  |                     |---------------------->|
     |                  |      Complete       |                       |
     |<---------------------------------------------------------------|
```

## 数据条带化

```c
          +--------------------+
          | Client Data Format |
          +--------------------+
                    |
        +-----------------------+
        |                       |
        v                       v
+================+     +================+
| Begin Object 0 |     | Begin Object 1 |
+================+     +================+
+----------------+     +----------------+
| stripe unit 1  |     | stripe unit 5  |
+----------------+     +----------------+
+----------------+     +----------------+
| stripe unit 2  |     | stripe unit 6  |
+----------------+     +----------------+
+----------------+     +----------------+
| stripe unit 3  |     | stripe unit 7  |
+----------------+     +----------------+
+----------------+     +----------------+
| stripe unit 4  |     | stripe unit 8  |
+----------------+     +----------------+
+----------------+     +----------------+
|  End Object 0  |     |  End Object 1  |
+----------------+     +----------------+
```

```c
                                  +--------------------+
                                  | Client Data Format |
                                  +--------------------+
                                            |
        +-----------------------+---------------------+-----------------------+
        |                       |                     |                       |
        v                       v                     v                       v
+================+     +================+     +================+     +================+   --+
| Begin Object 0 |     | Begin Object 1 |     | Begin Object 2 |     | Begin Object 3 |     |
+================+     +================+     +================+     +================+     |
+----------------+     +----------------+     +----------------+     +----------------+     |
| stripe unit 0  |     | stripe unit 1  |     | stripe unit 2  |     | stripe unit 3  |     |
+----------------+     +----------------+     +----------------+     +----------------+     |
+----------------+     +----------------+     +----------------+     +----------------+     |
| stripe unit 4  |     | stripe unit 5  |     | stripe unit 6  |     | stripe unit 7  |     +---+
+----------------+     +----------------+     +----------------+     +----------------+         | Object
+----------------+     +----------------+     +----------------+     +----------------+         | Set 1
| stripe unit 8  |     | stripe unit 9  |     | stripe unit 10 |     | stripe unit 11 |     +---+
+----------------+     +----------------+     +----------------+     +----------------+     |
+----------------+     +----------------+     +----------------+     +----------------+     |
| stripe unit 12 |     | stripe unit 13 |     | stripe unit 14 |     | stripe unit 15 |     |
+----------------+     +----------------+     +----------------+     +----------------+     |
+================+     +================+     +================+     +================+     |
|  End Object 0  |     |  End Object 1  |     |  End Object 2  |     |  End Object 3  |     |
+================+     +================+     +================+     +================+   --+


+================+     +================+     +================+     +================+   --+
| Begin Object 0 |     | Begin Object 1 |     | Begin Object 2 |     | Begin Object 3 |     |
+================+     +================+     +================+     +================+     |
+----------------+     +----------------+     +----------------+     +----------------+     |
| stripe unit 0  |     | stripe unit 1  |     | stripe unit 2  |     | stripe unit 3  |     |
+----------------+     +----------------+     +----------------+     +----------------+     |
+----------------+     +----------------+     +----------------+     +----------------+     |
| stripe unit 4  |     | stripe unit 5  |     | stripe unit 6  |     | stripe unit 7  |     +---+
+----------------+     +----------------+     +----------------+     +----------------+         | Object
+----------------+     +----------------+     +----------------+     +----------------+         | Set 1
| stripe unit 8  |     | stripe unit 9  |     | stripe unit 10 |     | stripe unit 11 |     +---+
+----------------+     +----------------+     +----------------+     +----------------+     |
+----------------+     +----------------+     +----------------+     +----------------+     |
| stripe unit 12 |     | stripe unit 13 |     | stripe unit 14 |     | stripe unit 15 |     |
+----------------+     +----------------+     +----------------+     +----------------+     |
+================+     +================+     +================+     +================+     |
|  End Object 0  |     |  End Object 1  |     |  End Object 2  |     |  End Object 3  |     |
+================+     +================+     +================+     +================+   --+
```
