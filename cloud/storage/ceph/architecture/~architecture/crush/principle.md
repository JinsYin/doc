# CRUSH 原理/详解

## 集群拓扑结构（层级结构） —— Cluster Map

Cluster Map 常见的节点类型（容灾域类型）

| Type ID | Type Name | Type ID | Type Name  |
| ------- | --------- | ------- | ---------- |
| 0       | osd       | 6       | pod        |
| 1       | host      | 7       | room       |
| 2       | chassis   | 8       | datacenter |
| 3       | rack      | 9       | region     |
| 4       | row       | 10      | root       |
| 5       | pdu       |

```c


                                                             +-------------+
                                                             |   type:root |
                                                             |     id:-7   |
                                                             | weight:8.00 |
                                                             +-------------+
                                                                    |
                                +----------------------------------------------------------------------+
                                |                                                                      |
                                v                                                                      v
                         +-------------+                                                        +-------------+
                         |   type:rack |                                                        |   type:rack |
                         |     id:-5   |                                                        |     id:-6   |
                         | weight:4.00 |                                                        | weight:4.00 |
                         +-------------+                                                        +-------------+
                                |                                                                      |
               +----------------------------------+                                  +----------------------------------+
               |                                  |                                  |                                  |
               v                                  v                                  v                                  v
        +-------------+                    +-------------+                    +-------------+                    +-------------+
        |   type:host |                    |   type:host |                    |   type:host |                    |   type:host |
        |     id:-1   |                    |     id:-2   |                    |     id:-3   |                    |     id:-4  |
        | weight:2.00 |                    | weight:2.00 |                    | weight:2.00 |                    | weight:2.00 |
        +-------------+                    +-------------+                    +-------------+                    +-------------+
               |                                  |                                  |                                  |
       +----------------+                 +----------------+                 +----------------+                 +----------------+
       |                |                 |                |                 |                |                 |                |
       v                v                 v                v                 v                v                 v                v
+-------------+  +-------------+   +-------------+  +-------------+   +-------------+  +-------------+   +-------------+  +-------------+
|   type:osd  |  |   type:osd  |   |   type:osd  |  |   type:osd  |   |   type:osd  |  |   type:osd  |   |   type:osd  |  |   type:osd  |
|     id:0    |  |     id:1    |   |     id:2    |  |     id:3    |   |     id:4    |  |     id:5    |   |     id:6    |  |     id:7    |
| weight:1.00 |  | weight:1.00 |   | weight:1.00 |  | weight:1.00 |   | weight:1.00 |  | weight:1.00 |   | weight:1.00 |  | weight:1.00 |
+-------------+  +-------------+   +-------------+  +-------------+   +-------------+  +-------------+   +-------------+  +-------------+
```

## 数据分布策略（映射策略） —— CRUSH Rule / Placement Rule

每条 Placement Rule 可以包含多个操作（op），每个操作可以是如下操作类型：

| 类型       | 描述                                                                                                                                                             |
| ---------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **take**   | * take 从 Cluster Map 中选择某个特定编号的 bucket（默认是 `root` 节点），作为后续步骤的输入                                                                      |
| **select** | * select 从输入的 bucket 中随机选择指定类型和数量的条目（items） <br> * Ceph 支持两种备份策略 —— 多副本和纠删码，对应两种 select 算法 —— `firstn` 和 `indep` |
| **emit**   | * emit 输出最终选择结果给上级调用者并返回                                                                                                                        |

**select** 操作的 type 为想要设置的容灾域类型：

* 若设置为 `rack`，则 **select** 将保证选出的所有副本都位于不同机架的磁盘上
* 若设置为 `host`，则 **select** 只保证选出的所有副本都位于不同主机的磁盘上

## 设备类（device classes）

Ceph 集群通常使用多种类型的存储设备构建：HDD，SSD，NVMe，如果需要将数据存储到不同类型的设备上，可以在 `host` 和 `osd` 两个层次结构之间增加一个 `classis`，用于分类磁盘设备。但需要管理员手动修改 CRUSH Map 。

* [New in Luminous: CRUSH device classes](https://ceph.com/community/new-luminous-crush-device-classes/)