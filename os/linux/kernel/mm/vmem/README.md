# 虚拟内存（Virtual Memory）管理

```sh
$ cat /proc/1/status | grep -E '^Vm'
VmPeak:	   34844 kB
VmSize:	   34844 kB
VmLck:	       0 kB
VmPin:	       0 kB
VmHWM:	    5344 kB
VmRSS:	    5344 kB
VmData:	    2608 kB
VmStk:	     132 kB
VmExe:	     248 kB
VmLib:	    3084 kB
VmPTE:	      92 kB
VmPMD:	      12 kB
VmSwap:	       0 kB
```

```sh
# 虚拟内存页大小
$ getconf PAGE_SIZE
```

## 设计初衷

Linux 采用了虚拟内存管理技术，该技术利用了大多数程序的一个典型特征，即 _访问局部性（locality of reference）_ 或 _局部性原理（principle of locality）_，以求高效利用 CPU 和 RAM（物理内存）资源。

### 局部性原理

| 访问局部性                      | 描述                                                                                                               |
| ------------------------------- | ------------------------------------------------------------------------------------------------------------------ |
| 空间局部性（Spatial locality）  | 程序倾向于访问在最近访问过的内存地址附近的内存（因为指令是顺序执行的，且有时会按照顺序处理数据结构，比如访问数组） |
| 时间局部性（Temporal locality） | 程序倾向于在不久的将来再次访问最近刚访问过的内存地址（比如循环）                                                   |

## 原理/方案

虚拟内存的规划之一是将每个程序使用的内存切割成小型的、固定大小的 _页（page）_（也叫 “虚拟页”，即虚拟地址空间中的一块），而将 RAM 划分成一系列与虚拟内存的页大小相同的 _页帧（page frame）_（也叫 “物理页”，即 RAM 中的一块）。

任一时刻，每个程序仅有部分页需要驻留在物理内存的页帧中。这些页构成了所谓的 _驻留集（resident set）_。程序未使用的页拷贝保存在 _交换区（swap area）_ 内 —— 这是磁盘空间中的保留区域，作为计算机物理内存的补充 —— 仅在需要时才会载入物理内存 。若进程欲访问的页目前没有在物理内存中将会发生 _页面错误（page fault）_，内核会立即挂起进程的执行，同时从磁盘中将该页载入内存。

为支持这一组织方式，内核需要为每个进程维护一张 _页表（page table）_，该页表描述了每页在进程虚拟地址空间（virtual address space）中的位置。页表中的每个条目要么指出一个虚拟页在 RAM 中的位置，要么表明其当前驻留在磁盘上（即交换空间）。

在进程虚拟地址空间中，并非所有的地址范围都需要页表条目。通常情况下，由于可能存在大段的虚拟地址空间并未投入使用，所以也没必要为其维护相应的页表条目。若进程试图访问的地址并无页表条目与之对应，那么进程将收到一个 SIGSEGV 信号。

由于内核能够为进程分配和释放页（以及页表条目），所以进程的有效虚拟地址范围在其生命周期可以发生变化，可能的场景如下：

* 由于栈向下增长超出了之前曾达到的位置
* 当在堆中分配或释放内存时，通过调用 `brk()`、`sbrk()`、`malloc()` 函数族来提升 program break 的位置
* 当调用 `mmap()` 创建内存映射是，或者当调用 `munmap()` 解除内存映射时

## 基本概念

* PMMU

虚拟内存的实现需要硬件中分页内存管理单元（PMMU）的支持。PMMU 把要访问的每个虚拟内存地址转换成相应的物理内存地址，当特定虚拟内存地址所对应的页没有驻留于 RAM 时，将响应页面错误（page fault）给内核。

## 内核空间与用户空间

## 参考

* [Locality of reference](https://en.wikipedia.org/wiki/Locality_of_reference)