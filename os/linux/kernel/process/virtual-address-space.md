# 进程内存布局/进程虚拟地址空间

![进程虚拟地址空间](.images/process-vas.png)

| -     | 描述                                             |
| ----- | ------------------------------------------------ |
| Stack | 包含临时数据，例如方法、函数、返回地址和局部变量 |
| Heap  | 运行时为进程动态分配的内存                       |
| Data  | 包含全局变量和静态变量                           |
| Text  | 程序计数器的值和处理器寄存器的内容表示的当前活动 |

每个进程所分配到的内存由多个部分组成，每个部分称为一个 _段（segment）_（进程虚拟内存的逻辑划分）。

| 段（Segment）                                 | 区域或区域内容                                    | 描述                                                                                                                                                                                                                                        |
| --------------------------------------------- | ------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 文本段（text segment）/代码段（code segment） | 进程运行时由 CPU 直接执行的程序机器指令（机器码） | * 文本段具有只读属性，以防止进程通过错误指针意外修改自身指令 <br> * 因为多个进程可以同时运行同一程序，所以又将文本段设为可共享，一份程序代码的拷贝可以映射到所有这些进程的虚拟地址空间中 <br> * 进程运行前就已分配完成                      |
| 数据段（data segment）/已初始化数据段         | 显式初始化的全局变量和静态变量                    | 当程序加载到内存时，从可执行文件中读取这些变量的值                                                                                                                                                                                          |
| bss 段（bss segment）/未初始化数据段          | 未进行显式初始化的全局变量和静态变量              | 在程序启动之前，系统将 BSS（Block Started by Symbol）段所有内存初始化为 0 <br> * 区分数据段和 BSS 段，是因为程序在磁盘上存储时没有必要为未经初始化的变量分配空间，只需记录为 BSS 段的位置及所需大小，直到运行时再由程序加载器来分配这一空间 |
| 栈（stack）                                   | 由栈帧（stack frame）组成的可以动态伸缩的段       | 系统会为每个当前调用的函数分配一个栈帧；栈帧中存储了函数的局部变量（即自动变量）、实参和返回值                                                                                                                                              |
| 堆（heap）                                    | 进程运行时为变量动态分配的内存区域                | * 堆顶端称为 program break  <br> * `malloc()`/`free()` 等系统调用可在堆上动态伸缩内存                                                                                                                                                       |

## 示例

* `size` 命令

`size` 命令可以查看二进制可执行文件的文本段（text）、已初始化数据段（data）、未初始化数据段（bss）的大小

```sh
$ size /bin/ls
   text	   data	    bss	    dec	    hex	filename
 105182	   2044	   3424	 110650	  1b03a	/bin/ls
```

* 解释说明 C 程序中各个变量属于哪个段

```c
#include <stdio.h>
#include <stdlib.h>

char globBuf[65536];          // bss 段
int primes[] = {2, 3, 5, 7};  // data 段

static int square(int x)      // 在 square() 函数的栈帧中被分配
{
    int result;               // 在 square() 函数的栈帧中被分配

    result = x * x;
    return result;            // 通过寄存器传递的返回值
}

static void doCalc(int val)   // 在 doCalc() 函数的栈帧中被分配
{
    printf("The square of %d is %d\n", val, square(val));

    if (val < 1000) {
        int t;                // 在 doCalc() 函数的栈帧中被分配

        t = val * val * val;
        printf("The cube of %d is %d\n", val, t);
    }
}

int main(int argc, char *argv[])  // 在 main() 函数的栈帧中被分配
{
    static int key = 9973;    // data 段
    static char mbuf[102400]; // bss 段
    char *p;                  // 在 main() 函数的栈帧中被分配

    p = malloc(1024);         // 指向 heap 段中的内存

    doCalc(key);

    exit(EXIT_SUCCESS);
}
```