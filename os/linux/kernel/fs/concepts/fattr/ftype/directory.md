# 目录（Directory）

## 存储方式

在文件系统中，目录的存储方式类似于普通文件，但有所不同：

* 其 inode 存储的 _文件类型_ 为 “目录”
* 目录是经特殊组织而成的文件，本质上是一个表格，包含 “文件名” 和 “inode 编号”

## 目录的 inode 结构

## 硬链接（Hard Link）

inode 并不存储文件名称，而是通过（目录数据块中）目录列表内的映射关系来定义文件名称。这样做的好处是，能够在相同或不同目录中创建多个指向相同 inode 的 “文件名称”。这些 ”文件名称“ 看起来像是一个 [文件](README.md)，实际上却共享相同的 inode ，因此这些 ”文件名称“ 也被称为 _硬链接_（hard link）。

简而言之，硬链接与其链接的源文件共享相同的 inode ，仅仅是文件名称不同。

如果要删除硬链接指向的文件，必须删除文件的所有 “名称”，系统才会释放文件的 inode 和数据块。原理是：当 `rm` 命令从目录列表删除一个 “文件名称” 时，将相应 inode 的链接数减 1 ，若链接数为 0 ，则释放该文件指向的 inode 和数据块。

硬链接的限制（可以使用符合链接进行规避）：

* 因为硬链接采用 inode 编号来指向物理文件，而 inode 仅在一个文件系统是唯一的，因此硬链接与其指代的文件必须驻留于同一文件系统
* 不能对目录创建硬链接，从而避免出现链接环路

增加硬链接文件一般不改变磁盘的空间与inode数目

## 目录内容

每个目录至少包含两个条目：`.` 和 `..`，前者是指向目录自身的硬链接，后者是指向其父目录的硬链接。除根目录外，每个目录都有父目录。对于根目录而言，`..` 是指向根目录自身的硬链接（即 `/..` == `/.` == `/`）

## 文件名

文件名可以包含除 “/” 和空字符（\0）外的所有字符。

## 路径名

## 当前工作目录

## 挂载

文件系统需要链接到目录树才能被使用，即所谓的挂载，挂载点一定是目录，该目录是文件系统的入口。假设我们想要读取文件 `/etc/hosts` 的内容，那么一般需要从根目录的 inode 内容开始往下读，直到找到正确的文件名。

```sh
$ $ ls -lid / /etc /etc/hosts
      2 drwxr-xr-x  32 root root  4096  7月 26 14:39 /
3670017 drwxr-xr-x 207 root root 12288  7月 26 14:51 /etc
3676053 -rwxrwxrwx   2 yin  yin   1437  7月 16 15:58 /etc/hosts
```

## 在目录的 inode 存储文件名的好处

* 访问目录时即可立即获取该目录下所有文件的文件名，而无需访问各个文件的 inode，尤其是当目录下的文件较多时
* 可以实现硬链接

## 示例

* 创建硬链接

```sh
$ echo 123 > a.txt

# 第 1 列：inode 编号
# 第 3 列：该 inode 的（硬）链接数（不包含如何符号链接）
$ ls -li a.txt
4328643 -rw-r--r-- 1 yin yin 4  7月 23 09:21 a.txt

$ ln a.txt b.txt

# inode 的链接数增加了 1
$ ln -li a.txt b.txt
4328643 -rw-r--r-- 2 yin yin 4  7月 23 09:21 a.txt
4328643 -rw-r--r-- 2 yin yin 4  7月 23 09:21 b.txt

$ echo 456 >> b.txt

$ cat a.txt
123
456
```