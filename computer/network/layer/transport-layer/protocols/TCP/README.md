# TCP 协议

## 关注的问题

* 顺序问题
* 丢包问题
* 连接维护
* 流量控制
* 拥塞控制

## TCP 包头格式

```plain
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|          Source Port          |       Destination Port        |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                        Sequence Number                        |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                    Acknowledgment Number                      |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|  Data |           |U|A|P|R|S|F|                               |
| Offset| Reserved  |R|C|S|S|Y|I|            Window             |
|       |           |G|K|H|T|N|N|                               |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|           Checksum            |         Urgent Pointer        |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                    Options                    |    Padding    |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                             data                              |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```

* `源端口（Source Port）` & `目标端口（Destination Port）`：与 UDP 相同
* `序号（Sequence Number）`：编号是为了解决乱序问题
* `确认序号（Acknowledgment Number）`：解决不丢包的问题
* `状态位`：
  * SYN: 发起一个连接
  * ACK: 回复
  * RST: 重新连接
  * FIN: 结束连接
* `窗口大小（Window）`：TCP 要做流量控制，通信双方个声明一个窗口，标识自己的处理能力，以便发送端可以控制发送的快慢

## TCP 三次握手 · 建立连接

TCP 的连接建立，常常称为 **三次握手**，即 `请求 -> 应答 -> 应答值应答` 的三个回合：

```plain
A：您好，我是 A
B：您好 A，我是 B
A：您好 B
```

状态时序图：

![TCP 三次握手](.images/tcp-3way-handshake.png)

## TCP 四次握手 · 断开连接

![TCP 三次握手](.images/tcp-4way-handshake.png)

## TCP 状态机

![TCP 状态机](.images/tcp-state-machine.png)

说明：

* 阿拉伯数字序号，代表连接过程的顺序
* 中文数字序号，代表连接断开过程的顺序
* 加粗的实线，代表客户端 A 的状态变迁
* 加粗的虚线，代表服务端 B 的状态变迁
